#!/usr/bin/env node

var express = require("express")
var http = require("http")
var path = require("path")
var fs = require("fs")
var request = require("request")

var app = express()

app.configure(function () {
    app.use(express.favicon())
    app.use(express.logger("dev"))
    app.use(express.bodyParser())
    app.use(express.cookieParser())
    app.use(express.methodOverride())
    app.use(app.router)
    app.use("/src", express.static(path.join(__dirname, "..", "src")))
    app.use(express.static(path.join(__dirname, "..", "static")))
});

app.configure("development", function () {
    app.use(express.errorHandler())
})

app.get("/lib/lymph-core.js", function (req, res) {
    res.sendfile("node_modules/lymph-core/lib/index-browser.js")
})

app.get("/lib/lymph-client.js", function (req, res) {
    res.sendfile("node_modules/lymph-client/lib/index-browser.js")
})

app.get("/lib/index.js", function (req, res) {
    res.sendfile("lib/index-client.js")
})

app.get("/lib/index-client.js.map", function (req, res) {
    res.sendfile("lib/index-client.js.map")
})

app.get("/cgi-bin/disks.com", function (req, res) {
    res.sendfile("misc/disks.json")
})

app.get("/cgi-bin/faces_data.com", function (req, res) {
    var data = [
        "40 2013-06-03 16:00:00 2013-06-03 17:00:00 fe_nf1 Jean nf1 col2 bone | N/A",
        "40 2013-06-04 06:00:00 2013-06-04 17:00:00 fe_nasa VBX | N/A",
        "40 2013-06-06 14:00:00 2013-06-07 21:00:00 orear_plasmin  | N/A"
    ]
    
    res.set("Content-Type", "text/plain")
    res.send(data.join("\n"))
})

app.get("/cgi-bin/faces.com", function (req, res) {

    var data = {
        account:"VUIIS_IVIS",
        savegrp:"on",
        user:"manager",
        saveusr:"on",
        savepwd:"on",
        passwd:"japon",
        end:"0"
    }

    request.post("http://faces.ccrc.uga.edu/ccrcfaces/login.php", function (e, r, body) {
        var pk = body.match(/NAME='pk' VALUE='([0-9a-z]*)'/)[1]
        res.send({pk: pk})
    }).form(data)
})

app.get("/cgi-bin/measurements.com", function (req, res) {
    res.sendfile("misc/measurements.json")
})

app.get("/cgi-bin/authorize.com", function (req, res) {
    if (req.cookies.uct_uid && req.cookies.uct_uid === "123") {
        res.send(200)
    }
    else {
        res.send(403)
    }
})

app.post("/cgi-bin/authenticate.com", function (req, res) {
    if (req.param("username") === "erick" && req.param("password") === "pass") {
        res.cookie("uct_uid", "123", { path: "/" })
        res.send("erick,admin")
    }
    else if (req.param("username") === "nicole" && req.param("password") === "pass") {
        res.cookie("uct_uid", "321", { path: "/" })
        res.send("nicole,user")
    }
    else {
        res.send(403)
    }
})

app.post("/items", function (req, res) {
    fs.writeFile("data.json", JSON.stringify(req.body), function (err) {
        res.send(200)
    })
});

http.createServer(app).listen(8080, function () {
    console.log("Server is running: http://0.0.0.0:8080");
})

// vim: ft=javascript
